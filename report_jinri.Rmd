---
output:
  word_document: default
  html_document: default
---

통계학과 진리장학금 빅데이터 분석 보고서

서울시 동별 지가와 관련된 지리적 요인 탐색
--------------------------------------------------------------------------


```{r setting, echo=FALSE}
setwd(".")
```

 1. 분석 목표

 교통편의성, 학군, 인구, 재개발 계획 등의 요인들은 (공시)지가에 직접 영향을 준다고 명시적으로 알려져 있다. 하지만 이 외에도 다양한 요인들이 영향을 미칠 수 있다고 알려져 있으며, 특히 한국 사회에서는 ‘집값’이 굉장히 민감한 이슈이기 때문에 관련 요인에 대한 관심은 항상 뜨거운 편이다. 예를 들어, 최근 강서구에서는 특수학교 건립을 반대하는 주민들이 지가 및 주택 가격을 떨어뜨린다는 주장을 제기하며 장애학생 부모와 갈등을 빚은 바 있다. 이에 본 분석에서는 지가에 영향을 미칠 수 있다고 여겨지는 잠재적 변수인 특수학교, 대형병원, 유흥업소, 숙박업소, 대형마트 등 주요 시설⋅인프라의 분포가 실제로도 지가와 관련되어 있는지 탐색해보고자 한다.


 2. 데이터 소개
 
  1) 반응변수: 2017년 서울특별시 법정동별 개별공시지가
  
   - 출처: 서울 열린데이터 광장 - 서울시 개별공시지가 정보
      
      (https://data.seoul.go.kr/openinf/fileview.jsp?infId=OA-1180)
      
   - 정의
   
   개별공시지가는 표준지공시지가를 이용하여 산정한 개별토지의 단위면적당 가격이다. 
   국토교통부장관은 매년 전국의 토지 중 대표성이 높은 표준지를 선정하고, 단위면적(m2)당 적정가격인 표준지공시지가를 결정하며 시장·군수·구청장은 표준지의 공시지가를 바탕으로 하여 개별토지의 단위면적당 적정가격인 개별공시지가를 산정한다. 개별공시지가는 개별토지의 용도(주거용, 상업용, 공업용 등), 도로·교통조건, 토지이용규제사항 등을 유사한 이용가치를 가진 표준지와 비교하여 토지가격비준표에 의해 산출된 가격배율에 표준지공시지가를 곱하여 산정된다.
   
   - 전처리 과정
   
   단위면적당 가격이기 때문에 같은 법정동 내에 여러 행의 토지 가격 정보가 포함되어 있었다. 따라서 행정구와 법정동을 기준으로 평균을 내어 해당 구 또는 동의 지가를 계산하였다. 
   
  2) 설명변수: 동별 대형마트, 특수학교, 대형병원, 유흥·단란주점, 숙박업소, 학교 개수
   
   - 출처: 서울 열린데이터 광장
   
   - 기본 전처리
   
   업체 주소 자료로부터 행정구역 정보(자치구명, 법정동명)를 추출하였다.
주소 자료에 법정동명이 아닌 행정동명이 입력되어있는 경우 법정동명으로 변경하였다.
결측값의 경우 직접 네이버 주소검색을 이용하여 행정구역 정보를 추출하여 채워넣었다. 
법정동별로 해당하는 자료의 개수에 대한 빈도표를 작성하였으며, 분석에는 이 빈도 데이터를 사용하였다.
   
   (법정동: 옛 지명 등에서 유래된 이름을 사용하여 법으로 정한 동으로 모든 정부 기관의 공무나 재산권 및 권리행사 등의 법률행위에 사용되는 동. 변동이 거의 없다.
   
   행정동: 행정 운영의 편의를 위하여 설정한 행정구역으로 도시의 확장, 인구의 이동 등 지역여건 변화와 주민 수의 증감에 따라 수시로 설치 또는 폐지할 수 있는 동)
   
   현재 서울특별시에는 총 25개 구, 467개의 법정동이 존재하며, 이름이 같은 동이 서로 다른 구에 있는 경우가 두 가지 존재하므로 (신사동: 강남구, 은평구 / 신정동: 양천구, 마포구) 같은 값으로 처리되지 않도록 구분하였다. 
   
   - 데이터별 특이사항
   
   유흥주점과 단란주점은 법적으로는 구분되어 있으나 이번 분석에서는 구별할 필요가 없으므로 '유흥업소'라는 상위 카테고리로 묶어서 고려하였다.
   
   유흥업소, 대형마트, 숙박업소 등은 폐업한 업소도 데이터셋에 포함되어 있으므로 현재 영업 중인 곳만 추출하여 사용하였다. 
   
   대형마트 데이터는 법적으로 매장 면적이 3000m^2 이상인 대형마트와 아울렛, 백화점 목록이다. 이 중 목록 안에 있더라도 식료품이나 의류, 생활용품을 종합적으로 판매하지 않는 곳은 삭제하였다. (예: 세운상가 등 전자상가 삭제, GS슈퍼 등 의류매장이 없는 슈퍼형 마트 삭제)
	
	또한 각 대형마트 홈페이지에 명시되어있는 점포 개수와 비교하여 목록에 없는 경우 추가하였다.
	마트와 백화점이 붙어있는 경우 각각 따로 집계하였다.
	아울렛 내에 있는 식료품매장이 따로 목록에 있는 경우 아울렛에 포함하여 하나로 집계하였다.
	
	당초 계획에서는 녹지 및 공원도 설명변수로 사용하려 하였으나 녹지, 공원의 면적이 천차만별이기 때문에 법정동별 개수로 활용하는 것은 합리적이지 못하다고 판단하였다.
	더불어 그 용도나 관리 실태 또한 다양하기 때문에 법정동별 면적으로 활용하는 것도 합리적이지 못하다고 판단하였다.
	따라서 녹지, 공원 변수는 설명변수 목록에서 제외하였다.
	
	
	- 변수 변환
	
숙박업소, 유흥업소, 학교의 경우 동별 개수 데이터가 동별 면적의 영향을 받을 것이므로 해당 법정동의 면적으로 나누어 1km^2당 개수로 변환하였다.

```{r landsize_merge, echo=FALSE}
# 동별 면적 데이터 불러오기
landsize <- read.csv("landsize_dong.csv", header=T)
names(landsize)[2] <- "dong"
names(landsize)[3] <- "landsize"
landsize <- landsize[, c(1, 2, 3)]

# 설명변수 dataset과 합치기 (merge)
dat <- read.csv("dataset_dong.csv", header=T)
dat <- merge(dat, landsize)
newDat <- dat
```

```{r landsize_cleaning}
newDat$yuheung <- newDat$yuheung / newDat$landsize
newDat$sukbak <- newDat$sukbak / newDat$landsize
newDat$school <- newDat$school / newDat$landsize
# 1m^2당 개수이므로 10^6을 곱하여 1km^2당 개수로 변환
newDat$yuheung <- newDat$yuheung * 10^6
newDat$sukbak <- newDat$sukbak * 10^6
newDat$school <- newDat$school * 10^6
```

대형마트, 대형병원, 특수학교의 경우 기본적으로 전체 업체 수가 적고 좁은 구역에 집중되어 있는 경향이 있으므로 0 또는 1의 바이너리 변수로 변환하였다.

```{r binary_dist, echo=FALSE}
print(paste0("특수학교 존재하는 동 비율: ", length(dat$specialsch[dat$specialsch>=1])/nrow(dat)))
print(paste0("학교 존재하는 동 비율: ", length(dat$school[dat$school>=1])/nrow(dat)))
print(paste0("병원 존재하는 동 비율: ", length(dat$hospital[dat$hospital>=1])/nrow(dat)))
print(paste0("대형마트 존재하는 동 비율: ", length(dat$store[dat$store>=1])/nrow(dat)))
print(paste0("숙박업소 존재하는 동 비율: ", length(dat$sukbak[dat$sukbak>=1])/nrow(dat)))
print(paste0("유흥업소 존재하는 동 비율: ", length(dat$yuheung[dat$yuheung>=1])/nrow(dat)))
```
	
	
```{r binary_cleaning}
# 1 이상의 값의 비율이 매우 낮은 특수학교, 병원, 대형마트만 binary variable로 변환
for (i in 1:nrow(newDat)) {
  if (newDat$specialsch[i] >= 1) {
    newDat$specialsch[i] <- 1
  } else newDat$specialsch[i] <- 0
}

for (i in 1:nrow(newDat)) {
  if (newDat$hospital[i] >= 1) {
    newDat$hospital[i] <- 1
  } else newDat$hospital[i] <- 0
}

for (i in 1:nrow(newDat)) {
  if (newDat$store[i] >= 1) {
    newDat$store[i] <- 1
  } else newDat$store[i] <- 0
}

dat <- newDat
```

3. 탐색적 데이터 분석 

 1) 반응변수 분포
 
  - 동별 평균 지가
  
```{r eda_dong_landvalue, echo=FALSE}
dong <- read.csv("finaldataset_dong.csv", header=T)
hist(dong$landvalue, main = "동별 평균 지가 분포", xlab = "동별 지가")
```

 2) 설명변수 분포

4. 모델 만들기

 1) Train & Test data 나누기

```{r train_test_division, echo=FALSE}
set.seed(123)
randomindex <- sample(1:nrow(dong), size=nrow(dong)*0.8, replace=F)
train_x<- dong[randomindex, -c(1,2)]
test_x<-dong[-randomindex, -c(1,2)]

train_y<-dong[randomindex, 2]
test_y<-dong[-randomindex,2]

traindong <- donga.frame(train_x, train_y)
testdong <- donga.frame(test_x, test_y)
```

 2) KNN
 
  - 5-fold Cross Validation으로 가장 적합한 K 찾기
  
```{r 5-fold_Cross_Validation}
library(class)
library(gmodels)
set.seed(123)
Candidate_k <- seq(from=1, to=29, by=2)
ErrorMat <- matrix(ncol=5, nrow=length(Candidate_k))
foldN <- sample(x=1:5, size=nrow(train_x), replace=T)
CrossTrain_X <- CrossTrain_Y <- CrossTest_X <- CrossTest_Y <- NULL

for(i in 1:5) {
  CrossTrain_X <- train_x[foldN !=i,]
  CrossTest_X <- train_x[foldN ==i,]
  
  CrossTrain_Y <- train_y[foldN !=i]
  CrossTest_Y <- train_y[foldN ==i]
  
  for(j in 1:length(Candidate_k)) {
    pred <- knn(train=CrossTrain_X, test=CrossTest_X, cl=log(CrossTrain_Y), k=Candidate_k[j])
    pred <- as.numeric(pred)
    mse <- mean((log(CrossTest_Y) - pred)^2)

    ErrorMat[j,i] <- mse
  }
}

mean_error <- apply(ErrorMat, 1, mean)
which.min(mean_error)
```

  - class library를 이용한 KNN

```{r KNN_and_accuracy}
pred_knn <- knn(train=train_x, test=test_x, cl=log(train_y), k=which.min(mean_error))
pred_knn <- as.numeric(pred_knn2)
mse<- mean((pred_knn - log(test_y))^2)

mse
```

  - kknn library를 이용한 KNN

```{r KNN}
library(kknn)
testdat$test_y <- log(testdat$test_y)
kknn_fit <- kknn(log(train_y)~., train=traindat, test=testdat, distance=2, kernel="gaussian")
pred_knn2 <- fitted(kknn_fit)

mse2 <- mean((pred_knn2-log(test_y))^2)
mean((exp(pred_knn2)-test_y)^2)

plot(pred_knn2 ~ log(test_y))
abline(a=0, b=1, col="red", lwd=2)
plot(exp(pred_knn2) ~ test_y)
abline(a=0, b=1, col="red", lwd=2)
cor(pred_knn2, log(test_y))
cor(exp(pred_knn2), test_y)
```

 3) Weighted KNN
 
  - LOOCV를 이용해 가장 적합한 k 찾기

```{r LOOCV}
LOOCV_kknn <- train.kknn(log(train_y)~., traindat, kmax=29, distance=2, kernel="gaussian")
LOOCV_kknn
```

    가장 적합한 k 는 29인 것으로 나왔다

```{r weighted_KNN}
kknn.fit2 <- kknn(log(train_y) ~., train=traindat, test=testdat,
                  k=29, distance=2, kernel="gaussian")
kknn.pred2 <- fitted(kknn.fit2)
plot(kknn.pred2 ~ testdat$test_y)
abline(a=0, b=1, col="red", lwd=2)
cor(kknn.pred2, testdat$test_y)
mean((kknn.pred2 - testdat$test_y)^2)
mean((exp(kknn.pred2) - test_y)^2)
```

    Best K인 29를 넣어 fit2를 만든 결과 적합 결과가 전보다 개선되었음을 알 수 있다. 
  
  4) Unweighted KNN
  
  - LOOCV를 이용해 가장 적합한 k 찾기
  
```{r LOOCV_unweighted}
LOOCV_kknn2 <- train.kknn(log(train_y)~., traindat, kmax=29, distance=2, kernel="rectangular")
LOOCV_kknn2
``` 

    가장 적합한 k 는 6인 것으로 나왔다
    
```{r unweighted_knn}
kknn.fit3 <- kknn(log(train_y)~., train=traindat, test=testdat,
                  k=16, distance=2, kernel="rectangular")
kknn.pred3 <- fitted(kknn.fit3)
plot(kknn.pred3 ~ testdat$test_y)
abline(a=0, b=1, col="red", lwd=2)
cor(kknn.pred3, testdat$test_y)
mean((kknn.pred3 - testdat$test_y)^2)
```

    kernel="rectangular"로 설정하니 "gaussian"일 때보다 결과가 약간 나쁘다.
  
